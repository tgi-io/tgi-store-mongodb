(function(){"use strict";var e=this,t=function(e){if(!1==this instanceof t)throw new Error("new operator required");e=e||{},this.storeType=e.storeType||"MongoStore",this.name=e.name||"a "+this.storeType,this.storeProperty={isReady:!1,canGetModel:!0,canPutModel:!0,canDeleteModel:!0,canGetList:!0};for(var r=getInvalidProperties(e,["name","storeType"]),o=[],n=0;n<r.length;n++)o.push("invalid property: "+r[n]);if(o.length>1)throw new Error("error creating Store: multiple errors");if(o.length)throw new Error("error creating Store: "+o[0])};t.prototype=Object.create(Store.prototype),t.prototype.onConnect=function(e,t){if("string"!=typeof e)throw new Error("argument must a url string");if("function"!=typeof t)throw new Error("argument must a callback");var r=this;try{this.mongoServer=new mongo.Server("127.0.0.1",27017,{auto_reconnect:!0}),this.mongoDatabase=new mongo.Db("tequilaStore",this.mongoServer,{safe:!0}),this.mongoDatabaseOpened=!1,this.mongoDatabase.open(function(e){if(e){t(r,e);try{r.mongoDatabase.close()}catch(o){console.log("error closing when fail open: "+o)}}else r.mongoDatabaseOpened=!0,r.storeProperty.isReady=!0,r.storeProperty.canGetModel=!0,r.storeProperty.canPutModel=!0,r.storeProperty.canDeleteModel=!0,t(r)})}catch(o){t(r,o)}},t.prototype.putModel=function(e,t){if(!(e instanceof Model))throw new Error("argument must be a Model");if(e.getObjectStateErrors().length)throw new Error("model has validation errors");if("function"!=typeof t)throw new Error("callBack required");var r,o=this;o.mongoDatabase.collection(e.modelType,function(o,n){if(o)return console.log("putModel collection error: "+o),void t(e,o);var i={},a=!1,s=e.attributes[0].value;for(r in e.attributes)e.attributes.hasOwnProperty(r)&&("id"==e.attributes[r].name?e.attributes[r].value||(a=!0):i[e.attributes[r].name]=e.attributes[r].value&&"ID"==e.attributes[r].type?mongo.ObjectID.createFromHexString(e.attributes[r].value):e.attributes[r].value);a?n.insert(i,{safe:!0},function(o){if(o)console.log("putModel insert error: "+o),t(e,o);else{for(r in e.attributes)e.attributes.hasOwnProperty(r)&&(e.attributes[r].value="id"==e.attributes[r].name?i._id.toString():i[e.attributes[r].name]&&"ID"==e.attributes[r].type?i[e.attributes[r].name].toString():i[e.attributes[r].name]);t(e)}}):(s=mongo.ObjectID.createFromHexString(s),n.update({_id:s},i,{safe:!0},function(o){if(o)console.log("putModel update error: "+o),t(e,o);else{for(r in e.attributes)e.attributes.hasOwnProperty(r)&&"id"!=e.attributes[r].name&&(e.attributes[r].value=i[e.attributes[r].name]);t(e)}}))})},t.prototype.getModel=function(e,t){if(!(e instanceof Model))throw new Error("argument must be a Model");if(e.getObjectStateErrors().length)throw new Error("model has validation errors");if(!e.attributes[0].value)throw new Error("ID not set");if("function"!=typeof t)throw new Error("callBack required");var r,o=this,n=e.attributes[0].value;try{n=mongo.ObjectID.createFromHexString(n)}catch(i){console.log("getModel createFromHexString error: "+i),t(e,i)}o.mongoDatabase.collection(e.modelType,function(o,i){return o?(console.log("getModel collection error: "+o),void t(e,o)):void i.findOne({_id:n},function(o,n){if(o)return console.log("getModel findOne ERROR: "+o),void t(e,o);if(null===n)t(e,Error("id not found in store"));else{for(r in e.attributes)e.attributes.hasOwnProperty(r)&&(e.attributes[r].value="id"==e.attributes[r].name?n._id.toString():n[e.attributes[r].name]&&"ID"==e.attributes[r].type?n[e.attributes[r].name].toString():n[e.attributes[r].name]);t(e)}})})},t.prototype.deleteModel=function(e,t){if(!(e instanceof Model))throw new Error("argument must be a Model");if(e.getObjectStateErrors().length)throw new Error("model has validation errors");if("function"!=typeof t)throw new Error("callBack required");var r,o=this,n=e.attributes[0].value;n=mongo.ObjectID.createFromHexString(n),o.mongoDatabase.collection(e.modelType,function(o,i){return o?(console.log("deleteModel collection error: "+o),void t(e,o)):void i.remove({_id:n},function(o,n){if(o||1!=n)return o||(o="error deleting: item is not equal to 1"),console.log("deleteModel remove ERROR: "+o),void t(e,o);for(r in e.attributes)e.attributes.hasOwnProperty(r)&&"id"==e.attributes[r].name&&(e.attributes[r].value=null);t(e)})})},t.prototype.getList=function(e,t,r,o){var n,i;if("function"==typeof o?(n=o,i=r):n=r,!(e instanceof List))throw new Error("argument must be a List");if(!(t instanceof Object))throw new Error("filter argument must be Object");if("function"!=typeof n)throw new Error("callBack required");var a=this;e.clear();var s={};for(var l in t)t.hasOwnProperty(l)&&(s[l]="ID"==e.model.getAttributeType(l)?mongo.ObjectID.createFromHexString(t[l]):t[l]);a.mongoDatabase.collection(e.model.modelType,function(t,r){function o(t,r){return t?(console.log("getList find error: "+t),void n(e,t)):void r.toArray(function(t,r){if(t)return console.log("getList toArray error: "+t),void n(e,t);for(var o=0;o<r.length;o++){r[o].id=r[o]._id.toString(),delete r[o]._id;var i=[];i.push(r[o].id);for(var a in r[o])"id"!=a&&i.push(r[o][a]);e._items.push(i)}e._itemIndex=e._items.length-1,n(e)})}return t?(console.log("getList collection error: "+t),void n(e,t)):void(i?r.find({query:s,$orderby:i},o):r.find(s,o))})},"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=CORE),exports.CORE=CORE):e.CORE=CORE}).call(this);